name: Notify Cal on Task Changes

on:
  push:
    branches: [ main, master ]
    paths:
      - 'data/tasks.json'
  workflow_dispatch:

jobs:
  notify-cal:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect task changes
        id: detect
        run: |
          git show HEAD:data/tasks.json > /tmp/current_tasks.json
          git show HEAD~1:data/tasks.json > /tmp/previous_tasks.json 2>/dev/null || echo '{"tasks":[]}' > /tmp/previous_tasks.json
          
          echo "Checking for new in-progress tasks..."
          
          jq -s '
            .[0].tasks as $prev |
            .[1].tasks as $curr |
            $curr | map(select(.status == "in_progress")) |
            map(.id as $id | 
              select(
                ($prev | map(.id) | contains([$id]) | not) or 
                (($prev[] | select(.id == $id) | .status) != "in_progress")
              )
            )
          ' /tmp/previous_tasks.json /tmp/current_tasks.json > /tmp/new_in_progress.json
          
          COUNT=$(jq 'length' /tmp/new_in_progress.json)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT new in-progress tasks"
          
          jq -c '.tasks' /tmp/current_tasks.json > /tmp/all_tasks.json
          echo "all_tasks=$(cat /tmp/all_tasks.json)" >> $GITHUB_OUTPUT
          
      - name: Send individual task notifications
        if: steps.detect.outputs.count > 0
        env:
          OPENCLAW_URL: ${{ secrets.OPENCLAW_WEBHOOK_URL }}
        run: |
          echo "Sending notifications for new in-progress tasks..."
          
          NEW_TASKS=$(cat /tmp/new_in_progress.json)
          LENGTH=$(echo "$NEW_TASKS" | jq 'length')
          
          for i in $(seq 0 $((LENGTH - 1))); do
            TASK=$(echo "$NEW_TASKS" | jq -c ".[$i]")
            TASK_ID=$(echo "$TASK" | jq -r '.id')
            TASK_TITLE=$(echo "$TASK" | jq -r '.title')
            
            echo "Notifying Cal about task: $TASK_ID - $TASK_TITLE"
            
            echo "$TASK" > /tmp/task_to_send.json
            
            HTTP_CODE=$(curl -s -o /tmp/curl_response.txt -w "%{http_code}" \
              -X POST "$OPENCLAW_URL" \
              -H "Content-Type: application/json" \
              -d @/tmp/task_to_send.json)
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "✅ Successfully notified Cal about $TASK_ID"
            else
              echo "❌ Failed to notify about $TASK_ID (HTTP $HTTP_CODE)"
              echo "Response: $(cat /tmp/curl_response.txt)"
            fi
          done
          
      - name: Send full task sync
        env:
          OPENCLAW_URL: ${{ secrets.OPENCLAW_WEBHOOK_URL }}
        run: |
          echo "Sending full task sync..."
          
          ALL_TASKS=$(cat /tmp/all_tasks.json)
          SYNC_PAYLOAD=$(jq -n \
            --argjson tasks "$ALL_TASKS" \
            '{tasks: $tasks, source: "github_actions", event: "tasks_sync"}')
          
          echo "$SYNC_PAYLOAD" > /tmp/sync_payload.json
          
          HTTP_CODE=$(curl -s -o /tmp/sync_response.txt -w "%{http_code}" \
            -X POST "$OPENCLAW_URL" \
            -H "Content-Type: application/json" \
            -H "X-Event-Type: tasks-sync" \
            -d @/tmp/sync_payload.json)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "✅ Full sync completed"
          else
            echo "⚠️ Full sync returned HTTP $HTTP_CODE"
            echo "Response: $(cat /tmp/sync_response.txt)"
          fi
